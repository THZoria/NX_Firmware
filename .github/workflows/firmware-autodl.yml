name: üéÆ Firmware Auto Downloader

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  download_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ‚öôÔ∏è Install required Python modules
        run: |
          pip install requests anynet beautifulsoup4

      - name: ‚¨áÔ∏è Setup hactool-linux
        run: |
          cp hactool-linux hactool
          chmod +x hactool

      - name: üîç Check firmware version (Switch 1 only, >=21.0.0 strict)
        id: version_check
        shell: bash
        run: |
          set +e

          RSS=$(curl -sL --fail https://yls8.mtheall.com/ninupdates/feed.php)
          CURL_STATUS=$?

          if [ $CURL_STATUS -ne 0 ] || [ -z "$RSS" ]; then
            echo "INFO: Impossible de r√©cup√©rer le RSS."
            echo "new_version=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extraire description Switch (ignore Switch 2)
          DESCRIPTION=$(echo "$RSS" | grep -oE '<description>Switch [0-9]+\.[0-9]+\.[0-9]+' | \
                        grep -v 'Switch 2' | \
                        head -n 1)

          if [ -z "$DESCRIPTION" ]; then
            echo "INFO: Aucun firmware Switch valide trouv√©."
            echo "new_version=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Description d√©tect√©e : $DESCRIPTION"

          VERSION=$(echo "$DESCRIPTION" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')

          if [ -z "$VERSION" ]; then
            echo "INFO: Impossible d'extraire la version."
            echo "new_version=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          MAJOR=$(echo "$VERSION" | cut -d. -f1)

          # Autorise uniquement 21+
          if [ "$MAJOR" -lt 21 ]; then
            echo "INFO: Firmware $VERSION ignor√© (<21.x)."
            echo "new_version=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Version valide d√©tect√©e : $VERSION"

          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/$VERSION")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "INFO: La release $VERSION existe d√©j√†."
            echo "new_version=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: Nouvelle version $VERSION d√©tect√©e !"
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "firmware_version=$VERSION" >> $GITHUB_OUTPUT
          fi

          set -e

      - name: üíª Execute download script and capture changelog
        id: download
        if: steps.version_check.outputs.new_version == 'true'
        run: |
          python3 firmware_downloader.py | tee firmware_output.txt
          FIRMWARE_VERSION=$(grep 'Folder: Firmware ' firmware_output.txt | awk '{print $NF}')
          echo "firmware_version=$FIRMWARE_VERSION" >> $GITHUB_OUTPUT
          tail -n 4 firmware_output.txt > changelog_body.txt

      - name: üßπ Clean and zip firmware
        if: steps.version_check.outputs.new_version == 'true'
        run: |
          VERSION="${{ steps.download.outputs.firmware_version }}"

          find . -type f -name "*.nca.*" -delete

          if [ -d "Firmware $VERSION" ]; then
            rm -f "Firmware $VERSION.zip"
            zip -rj "Firmware $VERSION.zip" "Firmware $VERSION/" -i "*.nca"
          fi

      - name: üìù Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.new_version == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('changelog_body.txt')) {
              const changelogBody = fs.readFileSync('changelog_body.txt', 'utf8');
              core.setOutput('release_body', changelogBody);
            } else {
              core.setOutput('release_body', 'No changelog available.');
            }

      - name: üì¶ Create Tag and Release
        if: steps.version_check.outputs.new_version == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.firmware_version }}
          name: Firmware ${{ steps.download.outputs.firmware_version }}
          body: |
            Automatic download of the official Nintendo Switch firmware version **${{ steps.download.outputs.firmware_version }}**.
            
            ---
            
            **Downloaded file details:**
            
            ${{ steps.prepare_body.outputs.release_body }}
          files: |
            Firmware ${{ steps.download.outputs.firmware_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
