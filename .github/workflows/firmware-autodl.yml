name: üéÆ Firmware Auto Downloader

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  download_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üêç Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: ‚öôÔ∏è Install required Python modules
        run: |
          pip install requests anynet beautifulsoup4

      - name: ‚¨áÔ∏è Setup hactool-linux
        run: |
          cp hactool-linux hactool
          chmod +x hactool
          
      - name: üîç Check firmware version (Switch 1 only)
        id: version_check
        run: |
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::Could not retrieve the firmware title for Switch 1 from the RSS feed."
            exit 1 
          fi

          LATEST_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')

          if [ -z "$LATEST_VERSION" ]; then
            echo "::error::Failed to parse LATEST_VERSION from title: $LATEST_TITLE"
            exit 1
          fi

          TAG_EXISTS=$(git ls-remote --tags origin $LATEST_VERSION)

          if [ ! -z "$TAG_EXISTS" ]; then
            echo "INFO: Tag $LATEST_VERSION already exists on GitHub. Stopping workflow to avoid re-upload."
            echo "new_version=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version $LATEST_VERSION found! Preparing to download..."
            echo "new_version=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: üíª Execute download script and capture changelog
        id: download
        if: steps.version_check.outputs.new_version == 'true'
        run: |
          python3 firmware_downloader.py | tee firmware_output.txt
          
          FIRMWARE_VERSION=$(grep 'Folder: Firmware ' firmware_output.txt | awk '{print $NF}')
          
          echo "firmware_version=$FIRMWARE_VERSION" >> $GITHUB_OUTPUT

          tail -n 4 firmware_output.txt > changelog_body.txt
          
      - name: üìù Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.new_version == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelogBody = fs.readFileSync('changelog_body.txt', 'utf8');
            core.setOutput('release_body', changelogBody);

      - name: üì¶ Create firmware zip (exclude .nca.1)
        if: steps.version_check.outputs.new_version == 'true'
        run: |
          EXCLUDED=$(find "Firmware ${{ steps.download.outputs.firmware_version }}" -name "*.nca.1" | wc -l)
          echo "Excluded $EXCLUDED variant files from zip"

          zip -r "Firmware ${{ steps.download.outputs.firmware_version }}.zip" \
            "Firmware ${{ steps.download.outputs.firmware_version }}" \
            -x "*.nca.1"

      - name: üì¶ Create Tag and Release
        if: steps.version_check.outputs.new_version == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.firmware_version }}
          name: Firmware ${{ steps.download.outputs.firmware_version }}
          body: |
            Automatic download of the official Nintendo Switch firmware version **${{ steps.download.outputs.firmware_version }}**.
            
            ---
            
            **Downloaded file details:**
            
            ${{ steps.prepare_body.outputs.release_body }}
            
            ---
            
            ‚ÑπÔ∏è Excluded variant files (.nca.1): see workflow logs
          files: |
            Firmware ${{ steps.download.outputs.firmware_version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
